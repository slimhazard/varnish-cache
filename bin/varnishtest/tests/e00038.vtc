varnishtest "ESI maxwait/req_total_timeout expiration in the backend FSM"

##
## Timeout while a busyobj is pending
##

server s1 {
	rxreq
	txresp -body {
		<html>
		Before include
		<esi:include src="/body"/><esi:include src="/body" maxwait="1000"/>
		After include
		</html>
	}
	rxreq
	delay 1.1
	txresp -body {
		Included file
	}
} -start

varnish v1 -arg "-p req_total_timeout=1" -vcl+backend {
	sub vcl_backend_response {
		set beresp.do_esi = true;
	}
} -start

client c1 {
	txreq
	rxresp
	expect resp.status == 200
} -run

logexpect l1 -v v1 -d 1 -q "Timestamp:Timeout" {
	expect 0 *	Begin        bereq
	expect * =	BereqURL     /body
	expect * =	Timestamp    Timeout
	expect 0 =	FetchError   "req_total_timeout elapsed"
	expect * =	BerespStatus 503
	expect * =	End

	expect 0 *	Begin      {^req \d+ esi$}
	expect * =	ReqURL     /body
	expect * =	Timestamp  Timeout
	expect 0 =	Error      "req_total_timeout elapsed"
	expect * =	RespStatus 503
	expect * =	End
} -run

##
## Timeout before the STARTFETCH step
##

server s1 -wait
server s1 {} -start

varnish v1 -vcl+backend {
	import vtc;

	sub vcl_miss {
		vtc.sleep(1.1s);
	}
}

logexpect l1 -v v1 -d 0 -q "Timestamp:Timeout" {
	expect 0 *	Begin        bereq
	expect * =	Timestamp    Timeout
	expect 0 =	FetchError   "req_total_timeout elapsed"
	expect * =	BerespStatus 503
	expect * =	End

	expect 0 *	Begin      req
	expect * =	Timestamp  Timeout
	expect 0 =	Error      "req_total_timeout elapsed"
	expect * =	RespStatus 503
	expect * =	End
} -start

client c1 {
	txreq -url /foo
	rxresp
	expect resp.status == 503
} -run

logexpect l1 -wait
